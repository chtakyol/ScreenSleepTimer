# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools

default_platform(:android)

platform :android do

  # ===============================
  # Build Lanes
  # ===============================

  desc "Build Dev Debug APK"
  lane :build_dev do
    gradle(
      task: "clean assembleDevDebug"
    )
  end

  desc "Build Staging Release APK"
  lane :build_staging do
    gradle(
      task: "clean assembleStagingRelease",
      properties: {
        "STAGING_KEYSTORE_PASSWORD" => ENV["STAGING_KEYSTORE_PASSWORD"],
        "STAGING_KEY_ALIAS" => ENV["STAGING_KEY_ALIAS"],
        "STAGING_KEY_PASSWORD" => ENV["STAGING_KEY_PASSWORD"]
      }
    )
  end

  desc "Build Production Release AAB"
  lane :build_production do
    gradle(
      task: "clean bundleProductionRelease",
      properties: {
        "RELEASE_KEYSTORE_PASSWORD" => ENV["RELEASE_KEYSTORE_PASSWORD"],
        "RELEASE_KEY_ALIAS" => ENV["RELEASE_KEY_ALIAS"],
        "RELEASE_KEY_PASSWORD" => ENV["RELEASE_KEY_PASSWORD"],
        "ADMOB_APP_ID_PROD" => ENV["ADMOB_APP_ID_PROD"],
        "ADMOB_BANNER_ID_PROD" => ENV["ADMOB_BANNER_ID_PROD"],
        "ADMOB_INTERSTITIAL_ID_PROD" => ENV["ADMOB_INTERSTITIAL_ID_PROD"]
      }
    )
  end

  desc "Build Production Release APK (for GitHub releases)"
  lane :build_production_apk do
    gradle(
      task: "clean assembleProductionRelease",
      properties: {
        "RELEASE_KEYSTORE_PASSWORD" => ENV["RELEASE_KEYSTORE_PASSWORD"],
        "RELEASE_KEY_ALIAS" => ENV["RELEASE_KEY_ALIAS"],
        "RELEASE_KEY_PASSWORD" => ENV["RELEASE_KEY_PASSWORD"],
        "ADMOB_APP_ID_PROD" => ENV["ADMOB_APP_ID_PROD"],
        "ADMOB_BANNER_ID_PROD" => ENV["ADMOB_BANNER_ID_PROD"],
        "ADMOB_INTERSTITIAL_ID_PROD" => ENV["ADMOB_INTERSTITIAL_ID_PROD"]
      }
    )
  end

  # ===============================
  # Firebase App Distribution Lanes
  # ===============================

  desc "Distribute Dev build to Firebase App Distribution"
  lane :distribute_dev do
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      apk_path: "app/build/outputs/apk/dev/debug/app-dev-debug.apk",
      groups: "internal-developers",
      release_notes: ENV["RELEASE_NOTES"] || "Dev build from CI/CD pipeline",
      firebase_cli_token: ENV["FIREBASE_TOKEN"]
    )
  end

  desc "Distribute Staging build to Firebase App Distribution"
  lane :distribute_staging do
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      apk_path: "app/build/outputs/apk/staging/release/app-staging-release.apk",
      groups: "internal-developers,beta-testers",
      release_notes: ENV["RELEASE_NOTES"] || "Staging build from CI/CD pipeline",
      firebase_cli_token: ENV["FIREBASE_TOKEN"]
    )
  end

  # ===============================
  # Google Play Console Lanes
  # ===============================

  desc "Upload Production AAB to Google Play Console (Internal Testing Track)"
  lane :upload_to_play_store_internal do
    upload_to_play_store(
      track: 'internal',
      aab: 'app/build/outputs/bundle/productionRelease/app-production-release.aab',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key_data: ENV["PLAY_STORE_SERVICE_ACCOUNT_JSON"]
    )
  end

  # ===============================
  # Combined Lanes (Build + Distribute)
  # ===============================

  desc "Build and distribute Dev build"
  lane :dev_release do
    build_dev
    distribute_dev
  end

  desc "Build and distribute Staging build"
  lane :staging_release do
    build_staging
    distribute_staging
  end

  desc "Build and upload Production release to Play Store"
  lane :production_release do
    build_production
    upload_to_play_store_internal
  end

  # ===============================
  # Testing Lanes
  # ===============================

  desc "Run unit tests"
  lane :test do
    gradle(task: "testDebugUnitTest")
  end

  desc "Run unit tests for all variants"
  lane :test_all do
    gradle(task: "test")
  end

  # ===============================
  # Legacy Lanes (kept for backward compatibility)
  # ===============================

  desc "Build debug APK"
  lane :build_debug do
    gradle(task: "assembleDebug")
  end

  desc "Deploy test version to Firebase (legacy)"
  lane :upload_debug_apk_to_firebase do
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID"],
      apk_path: "./app-debug.apk",
      firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"]
    )
  end
end
