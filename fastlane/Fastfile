# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools

default_platform(:android)

platform :android do

  # ===============================
  # Build Lanes
  # ===============================

  desc "Build Dev Debug APK"
  lane :build_dev do
    gradle(
      task: "clean assembleDevDebug"
    )
  end

  desc "Build Staging Release APK"
  lane :build_staging do
    gradle(
      task: "clean assembleStagingRelease",
      properties: {
        "STAGING_KEYSTORE_PASSWORD" => ENV["STAGING_KEYSTORE_PASSWORD"],
        "STAGING_KEY_ALIAS" => ENV["STAGING_KEY_ALIAS"],
        "STAGING_KEY_PASSWORD" => ENV["STAGING_KEY_PASSWORD"]
      }
    )
  end

  desc "Build Production Release AAB"
  lane :build_production do
    gradle(
      task: "clean bundleProductionRelease",
      properties: {
        "RELEASE_KEYSTORE_PASSWORD" => ENV["RELEASE_KEYSTORE_PASSWORD"],
        "RELEASE_KEY_ALIAS" => ENV["RELEASE_KEY_ALIAS"],
        "RELEASE_KEY_PASSWORD" => ENV["RELEASE_KEY_PASSWORD"],
        "ADMOB_APP_ID_PROD" => ENV["ADMOB_APP_ID_PROD"],
        "ADMOB_BANNER_ID_PROD" => ENV["ADMOB_BANNER_ID_PROD"],
        "ADMOB_INTERSTITIAL_ID_PROD" => ENV["ADMOB_INTERSTITIAL_ID_PROD"]
      }
    )
  end

  desc "Build Production Release APK (for GitHub releases)"
  lane :build_production_apk do
    gradle(
      task: "clean assembleProductionRelease",
      properties: {
        "RELEASE_KEYSTORE_PASSWORD" => ENV["RELEASE_KEYSTORE_PASSWORD"],
        "RELEASE_KEY_ALIAS" => ENV["RELEASE_KEY_ALIAS"],
        "RELEASE_KEY_PASSWORD" => ENV["RELEASE_KEY_PASSWORD"],
        "ADMOB_APP_ID_PROD" => ENV["ADMOB_APP_ID_PROD"],
        "ADMOB_BANNER_ID_PROD" => ENV["ADMOB_BANNER_ID_PROD"],
        "ADMOB_INTERSTITIAL_ID_PROD" => ENV["ADMOB_INTERSTITIAL_ID_PROD"]
      }
    )
  end

  # ===============================
  # Note: Firebase App Distribution is handled directly via Firebase CLI in GitHub Actions
  # ===============================

  # ===============================
  # Google Play Console Lanes
  # ===============================

  desc "Upload Production AAB to Google Play Console (Internal Testing Track)"
  lane :upload_to_play_store_internal do
    upload_to_play_store(
      track: 'internal',
      aab: 'app/build/outputs/bundle/productionRelease/app-production-release.aab',
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      json_key_data: ENV["PLAY_STORE_SERVICE_ACCOUNT_JSON"]
    )
  end

  # ===============================
  # Combined Lanes (Build + Upload)
  # ===============================

  desc "Build and upload Production release to Play Store"
  lane :production_release do
    build_production
    upload_to_play_store_internal
  end

  # ===============================
  # Testing Lanes
  # ===============================

  desc "Run unit tests"
  lane :test do
    gradle(task: "testDebugUnitTest")
  end

  desc "Run unit tests for all variants"
  lane :test_all do
    gradle(task: "test")
  end

  # ===============================
  # Legacy Lanes (kept for backward compatibility)
  # ===============================

  desc "Build debug APK"
  lane :build_debug do
    gradle(task: "assembleDebug")
  end
end
